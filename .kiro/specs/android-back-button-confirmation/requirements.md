# Android 导航返回键确认功能需求文档

## 1. 功能概述

在 Android 导航页面（NavigationActivity）中添加返回键拦截和退出确认逻辑，防止用户通过实体返回键意外退出导航，确保正确触发 `MapBoxEvent.navigation_cancelled` 事件。

## 2. 问题描述

### 2.1 当前问题
- 用户可以通过 Android 实体返回键直接退出导航页面
- 退出时未经过确认流程，可能导致意外退出
- 直接退出时 `MapBoxEvent.navigation_cancelled` 事件可能未正确触发
- 导航状态未正确清理

### 2.2 影响范围
- Flutter 层无法正确接收导航取消事件
- 导航资源（历史记录、语音播报等）可能未正确释放
- 用户体验不佳，容易误操作

## 3. 用户故事

### 3.1 作为导航用户
**我想要**：在导航过程中按下返回键时，系统弹出确认对话框  
**以便于**：避免误操作导致导航意外退出

**验收标准**：
- 在导航进行中按下返回键，显示确认对话框
- 对话框包含明确的提示信息和操作按钮
- 用户可以选择继续导航或退出导航

### 3.2 作为导航用户
**我想要**：确认退出后，导航正确停止并清理资源  
**以便于**：确保应用状态正确，Flutter 层能接收到取消事件

**验收标准**：
- 用户确认退出后，调用 `stopNavigation()` 方法
- 触发 `MapBoxEvent.navigation_cancelled` 事件
- 正确清理导航资源（历史记录、语音播报等）
- Activity 正常关闭

### 3.3 作为导航用户
**我想要**：在未开始导航时按返回键直接退出  
**以便于**：快速返回上一页面

**验收标准**：
- 在路线规划阶段（未开始导航）按返回键，直接退出无需确认
- 在自由驾驶模式下按返回键，直接退出无需确认

## 4. 功能需求

### 4.1 返回键拦截
- **FR-1.1**: 重写 `onBackPressed()` 方法或使用 `OnBackPressedCallback`
- **FR-1.2**: 根据导航状态决定是否显示确认对话框
- **FR-1.3**: 在导航进行中（`isNavigationInProgress == true`）时拦截返回键

### 4.2 确认对话框
- **FR-2.1**: 使用 Material Design 风格的 AlertDialog
- **FR-2.2**: 对话框标题：显示清晰的提示信息（如"退出导航？"）
- **FR-2.3**: 对话框内容：说明退出后果（如"导航将被取消"）
- **FR-2.4**: 提供两个操作按钮：
  - 取消按钮：关闭对话框，继续导航
  - 确认按钮：退出导航
- **FR-2.5**: 对话框支持主题适配（日间/夜间模式）
- **FR-2.6**: 对话框文本支持国际化

### 4.3 退出处理
- **FR-3.1**: 用户确认退出后，调用现有的 `stopNavigation()` 方法
- **FR-3.2**: 确保 `MapBoxEvent.navigation_cancelled` 事件正确触发
- **FR-3.3**: 确保所有导航资源正确清理
- **FR-3.4**: Activity 正常关闭

### 4.4 特殊场景处理
- **FR-4.1**: 在路线规划阶段（未开始导航），按返回键直接退出
- **FR-4.2**: 在自由驾驶模式下，按返回键直接退出
- **FR-4.3**: 在路线选择界面，按返回键直接退出

## 5. 非功能需求

### 5.1 性能要求
- **NFR-1.1**: 对话框响应时间 < 200ms
- **NFR-1.2**: 退出处理时间 < 500ms

### 5.2 兼容性要求
- **NFR-2.1**: 支持 Android API 21+
- **NFR-2.2**: 兼容 Android 13+ 的返回手势
- **NFR-2.3**: 适配不同屏幕尺寸和分辨率

### 5.3 用户体验要求
- **NFR-3.1**: 对话框文本清晰易懂
- **NFR-3.2**: 按钮布局符合 Android 设计规范
- **NFR-3.3**: 支持主题自动切换

### 5.4 可维护性要求
- **NFR-4.1**: 代码遵循现有项目规范
- **NFR-4.2**: 添加适当的日志记录
- **NFR-4.3**: 添加代码注释说明逻辑

## 6. 技术约束

### 6.1 Android 版本兼容
- 使用 `OnBackPressedDispatcher` API（Android 13+ 推荐）
- 保留 `onBackPressed()` 兼容旧版本

### 6.2 现有架构
- 不修改现有的 `stopNavigation()` 方法逻辑
- 不影响其他退出导航的方式（如点击停止按钮）
- 保持与 iOS 端行为一致性

### 6.3 依赖库
- 使用 AndroidX AppCompat 库
- 使用 Material Components 库

## 7. 验收标准

### 7.1 功能验收
- [ ] 导航进行中按返回键，显示确认对话框
- [ ] 对话框文本清晰，按钮功能正确
- [ ] 点击"取消"按钮，对话框关闭，导航继续
- [ ] 点击"确认"按钮，导航停止，Activity 关闭
- [ ] `MapBoxEvent.navigation_cancelled` 事件正确触发
- [ ] 未开始导航时按返回键，直接退出

### 7.2 兼容性验收
- [ ] 在 Android 5.0 (API 21) 上测试通过
- [ ] 在 Android 13+ 上测试通过
- [ ] 日间/夜间主题切换正常
- [ ] 不同语言环境下文本显示正确

### 7.3 性能验收
- [ ] 对话框响应流畅，无卡顿
- [ ] 退出处理快速完成
- [ ] 无内存泄漏

## 8. 测试场景

### 8.1 基本场景
1. 启动导航 → 按返回键 → 显示对话框 → 点击取消 → 导航继续
2. 启动导航 → 按返回键 → 显示对话框 → 点击确认 → 导航停止
3. 路线规划中 → 按返回键 → 直接退出

### 8.2 边界场景
1. 导航即将到达 → 按返回键 → 显示对话框 → 确认退出
2. 导航偏航重新规划中 → 按返回键 → 显示对话框
3. 历史记录录制中 → 按返回键 → 确认退出 → 历史记录正确保存

### 8.3 异常场景
1. 对话框显示时旋转屏幕 → 对话框保持显示
2. 对话框显示时应用进入后台 → 对话框正确处理
3. 快速连续按返回键 → 只显示一个对话框

## 9. 实现优先级

### P0 - 必须实现
- 返回键拦截逻辑
- 确认对话框 UI
- 退出处理流程
- 事件触发

### P1 - 应该实现
- 主题适配
- 国际化支持
- 日志记录

### P2 - 可以实现
- 对话框动画效果
- 自定义对话框样式

## 10. 相关文件

### 需要修改的文件
- `android/src/main/kotlin/com/eopeter/fluttermapboxnavigation/activity/NavigationActivity.kt`

### 可能需要修改的文件
- `android/src/main/res/values/strings.xml` - 添加对话框文本
- `android/src/main/res/values-zh/strings.xml` - 添加中文文本
- `android/src/main/res/values/styles.xml` - 对话框样式（可选）

## 11. 参考资料

- [Android OnBackPressedDispatcher 文档](https://developer.android.com/guide/navigation/custom-back)
- [Material Design - Dialogs](https://material.io/components/dialogs)
- 现有项目中的对话框实现参考
