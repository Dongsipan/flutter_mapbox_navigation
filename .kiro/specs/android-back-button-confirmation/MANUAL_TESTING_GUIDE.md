# Android 导航返回键确认功能 - 手动测试指南

## 文档信息
- **功能**: Android 导航返回键确认对话框
- **版本**: 1.0
- **创建日期**: 2024
- **相关需求**: 7.1, 8.1
- **相关任务**: 4.2 手动测试基本场景

## 测试目标

本测试指南旨在验证 Android 导航返回键确认功能的基本场景，确保：
1. 导航进行中按返回键显示确认对话框
2. 对话框交互功能正确（取消/确认按钮）
3. 未开始导航时按返回键直接退出
4. 对话框主题在日间/夜间模式下正确显示
5. 导航正确停止并触发取消事件

## 测试环境要求

### 硬件要求
- Android 设备或模拟器
- 支持 GPS 定位（真机测试推荐）
- 物理返回键或虚拟返回键

### 软件要求
- Android 版本: 5.0 (API 21) 或更高
- 已安装测试应用
- 已授予位置权限
- 网络连接正常（用于加载地图和路线）

### 测试数据
- 起点坐标: 任意有效位置
- 终点坐标: 距离起点至少 1 公里的位置
- 建议使用真实地址进行测试

---

## 测试场景

### 场景 1: 导航中按返回键显示对话框

**测试目的**: 验证在导航进行中按返回键时，系统显示确认对话框

**前置条件**:
- 应用已启动
- 已授予位置权限
- 已规划路线并开始导航
- 导航状态为"进行中"（isNavigationInProgress = true）

**测试步骤**:
1. 启动应用
2. 选择起点和终点
3. 点击"开始导航"按钮
4. 等待导航开始（显示导航界面，语音播报开始）
5. 按下设备的返回键（物理键或虚拟键）

**预期结果**:
- ✅ 显示确认对话框
- ✅ 对话框标题显示: "退出导航？"（中文）或 "Exit Navigation?"（英文）
- ✅ 对话框消息显示: "导航将被取消，确定要退出吗？"（中文）或 "Navigation will be cancelled. Are you sure you want to exit?"（英文）
- ✅ 对话框包含两个按钮: "取消" 和 "退出"（中文）或 "Cancel" 和 "Exit"（英文）
- ✅ 对话框样式符合 Material Design 规范
- ✅ 导航继续进行（未停止）

**验证要点**:
- [ ] 对话框在按下返回键后立即显示（< 200ms）
- [ ] 对话框文本清晰可读
- [ ] 对话框按钮布局正确（取消在左，退出在右）
- [ ] 对话框背景有半透明遮罩
- [ ] 导航界面在对话框后面仍然可见

**失败处理**:
- 如果对话框未显示，检查导航是否真正开始
- 如果文本显示错误，检查字符串资源文件
- 如果对话框样式异常，检查主题配置

---

### 场景 2: 点击取消按钮继续导航

**测试目的**: 验证点击对话框的"取消"按钮后，对话框关闭，导航继续

**前置条件**:
- 完成场景 1，对话框已显示

**测试步骤**:
1. 在显示的确认对话框中，点击"取消"按钮
2. 观察对话框和导航状态

**预期结果**:
- ✅ 对话框立即关闭
- ✅ 导航继续进行（语音播报继续，地图更新继续）
- ✅ 导航界面恢复正常交互
- ✅ 可以再次按返回键显示对话框

**验证要点**:
- [ ] 对话框关闭动画流畅
- [ ] 导航状态未改变（isNavigationInProgress 仍为 true）
- [ ] 语音播报未中断
- [ ] 地图位置跟踪正常
- [ ] 路线显示正常

**失败处理**:
- 如果对话框未关闭，检查按钮点击事件
- 如果导航停止，检查按钮逻辑是否正确

---

### 场景 3: 点击确认按钮退出导航

**测试目的**: 验证点击对话框的"退出"按钮后，导航正确停止并退出

**前置条件**:
- 应用已启动
- 已规划路线并开始导航
- 导航状态为"进行中"

**测试步骤**:
1. 按下设备的返回键，显示确认对话框
2. 在对话框中，点击"退出"按钮
3. 观察导航停止过程和 Activity 关闭

**预期结果**:
- ✅ 对话框立即关闭
- ✅ 调用 stopNavigation() 方法
- ✅ 触发 MapBoxEvent.navigation_cancelled 事件
- ✅ 导航资源正确清理（历史记录、语音播报、路线等）
- ✅ NavigationActivity 关闭，返回上一页面
- ✅ 整个过程在 500ms 内完成

**验证要点**:
- [ ] 对话框关闭流畅
- [ ] 导航停止无延迟
- [ ] Activity 关闭动画正常
- [ ] Flutter 层接收到 navigation_cancelled 事件（可通过日志验证）
- [ ] 无崩溃或异常

**日志验证**:
在 Android Studio Logcat 中查找以下日志：
```
NavigationActivity: User confirmed exit navigation
NavigationActivity: Stopping navigation
NavigationActivity: Sending event: navigation_cancelled
NavigationActivity: Activity finishing
```

**失败处理**:
- 如果导航未停止，检查 stopNavigation() 调用
- 如果事件未触发，检查事件发送逻辑
- 如果 Activity 未关闭，检查 finish() 调用

---

### 场景 4: 未开始导航时按返回键直接退出

**测试目的**: 验证在未开始导航时按返回键，直接退出无需确认

**前置条件**:
- 应用已启动
- 进入导航页面但未开始导航（路线规划阶段）
- 导航状态为"未开始"（isNavigationInProgress = false）

**测试步骤**:
1. 启动应用
2. 选择起点和终点
3. 等待路线规划完成（显示路线预览）
4. **不要点击"开始导航"按钮**
5. 按下设备的返回键

**预期结果**:
- ✅ **不显示**确认对话框
- ✅ NavigationActivity 直接关闭
- ✅ 返回上一页面
- ✅ 无崩溃或异常

**验证要点**:
- [ ] 确认对话框未显示
- [ ] Activity 立即关闭
- [ ] 返回动画正常
- [ ] 无错误日志

**日志验证**:
在 Android Studio Logcat 中查找以下日志：
```
NavigationActivity: Back pressed, isNavigationInProgress=false
NavigationActivity: Navigation not in progress, finishing activity
```

**失败处理**:
- 如果显示对话框，检查 isNavigationInProgress 状态管理
- 如果 Activity 未关闭，检查 finish() 调用

---

### 场景 5: 对话框主题在日间模式下的显示

**测试目的**: 验证对话框在日间模式下的主题和样式正确

**前置条件**:
- 设备设置为日间模式（浅色主题）
- 应用已启动并开始导航

**测试步骤**:
1. 确认设备处于日间模式
   - 设置 → 显示 → 深色主题 → 关闭
2. 启动应用并开始导航
3. 按下返回键显示确认对话框
4. 观察对话框的颜色和样式

**预期结果**:
- ✅ 对话框背景为浅色（白色或浅灰色）
- ✅ 标题文字为深色（黑色或深灰色）
- ✅ 消息文字为深色
- ✅ "退出"按钮文字为蓝色（主题色）
- ✅ "取消"按钮文字为灰色
- ✅ 对话框边框和阴影清晰可见
- ✅ 整体视觉效果符合 Material Design Light 主题

**验证要点**:
- [ ] 对话框背景色: #FFFFFF 或类似浅色
- [ ] 文字颜色对比度足够（易读）
- [ ] 按钮颜色符合设计规范
- [ ] 无颜色异常或显示错误

**参考截图位置**:
- 保存截图到: `screenshots/dialog_light_theme.png`

**失败处理**:
- 如果颜色错误，检查 `res/values/styles.xml` 中的 AlertDialogTheme
- 如果主题未应用，检查对话框创建时的主题参数

---

### 场景 6: 对话框主题在夜间模式下的显示

**测试目的**: 验证对话框在夜间模式下的主题和样式正确

**前置条件**:
- 设备设置为夜间模式（深色主题）
- 应用已启动并开始导航

**测试步骤**:
1. 确认设备处于夜间模式
   - 设置 → 显示 → 深色主题 → 开启
2. 启动应用并开始导航
3. 按下返回键显示确认对话框
4. 观察对话框的颜色和样式

**预期结果**:
- ✅ 对话框背景为深色（深灰色或黑色）
- ✅ 标题文字为浅色（白色或浅灰色）
- ✅ 消息文字为浅色
- ✅ "退出"按钮文字为蓝色（主题色）
- ✅ "取消"按钮文字为浅灰色
- ✅ 对话框边框和阴影适配深色背景
- ✅ 整体视觉效果符合 Material Design Dark 主题

**验证要点**:
- [ ] 对话框背景色: #1E1E1E 或类似深色
- [ ] 文字颜色对比度足够（易读）
- [ ] 按钮颜色符合设计规范
- [ ] 无颜色异常或显示错误
- [ ] 与日间模式形成明显对比

**参考截图位置**:
- 保存截图到: `screenshots/dialog_dark_theme.png`

**失败处理**:
- 如果颜色错误，检查 `res/values-night/styles.xml` 中的 AlertDialogTheme
- 如果主题未切换，检查应用是否支持 DayNight 主题

---

### 场景 7: 对话框主题动态切换

**测试目的**: 验证在应用运行时切换系统主题，对话框主题能正确更新

**前置条件**:
- 设备支持动态主题切换
- 应用已启动并开始导航

**测试步骤**:
1. 设备设置为日间模式
2. 启动应用并开始导航
3. 按下返回键显示对话框，观察日间主题
4. 点击"取消"关闭对话框
5. 切换设备到夜间模式（下拉通知栏 → 点击深色主题）
6. 再次按下返回键显示对话框
7. 观察对话框主题是否更新

**预期结果**:
- ✅ 第一次显示对话框为日间主题
- ✅ 切换系统主题后，应用主题自动更新
- ✅ 第二次显示对话框为夜间主题
- ✅ 主题切换流畅，无闪烁或异常

**验证要点**:
- [ ] 主题切换响应及时
- [ ] 对话框颜色正确更新
- [ ] 无需重启应用
- [ ] 导航状态不受影响

**失败处理**:
- 如果主题未更新，检查应用是否使用 DayNight 主题
- 如果需要重启应用，检查 Activity 配置

---

## 边界场景测试（可选）

### 场景 8: 快速连续按返回键

**测试目的**: 验证快速连续按返回键不会创建多个对话框

**测试步骤**:
1. 开始导航
2. 快速连续按返回键 3-5 次

**预期结果**:
- ✅ 只显示一个对话框
- ✅ 无重复对话框
- ✅ 无崩溃或异常

**验证要点**:
- [ ] isExitDialogShowing 标志位正常工作
- [ ] 日志显示防重复逻辑生效

---

### 场景 9: 对话框显示时旋转屏幕

**测试目的**: 验证对话框在屏幕旋转时的行为

**测试步骤**:
1. 开始导航
2. 按返回键显示对话框
3. 旋转设备屏幕（竖屏 ↔ 横屏）

**预期结果**:
- ✅ 对话框保持显示或正确重建
- ✅ 对话框内容和样式正确
- ✅ 无崩溃

**注意**: 
- 如果对话框消失，这是 AlertDialog 的默认行为，可接受
- 如果需要保持对话框，需要使用 DialogFragment（可选优化）

---

### 场景 10: 对话框显示时应用进入后台

**测试目的**: 验证对话框在应用进入后台时的行为

**测试步骤**:
1. 开始导航
2. 按返回键显示对话框
3. 按 Home 键将应用切换到后台
4. 重新打开应用

**预期结果**:
- ✅ 对话框正确处理（关闭或保持）
- ✅ 导航状态正确
- ✅ 无崩溃

---

## 国际化测试

### 场景 11: 中文环境测试

**测试步骤**:
1. 设置设备语言为中文（简体）
2. 启动应用并开始导航
3. 按返回键显示对话框

**预期结果**:
- ✅ 对话框标题: "退出导航？"
- ✅ 对话框消息: "导航将被取消，确定要退出吗？"
- ✅ 确认按钮: "退出"
- ✅ 取消按钮: "取消"

---

### 场景 12: 英文环境测试

**测试步骤**:
1. 设置设备语言为英文（English）
2. 启动应用并开始导航
3. 按返回键显示对话框

**预期结果**:
- ✅ 对话框标题: "Exit Navigation?"
- ✅ 对话框消息: "Navigation will be cancelled. Are you sure you want to exit?"
- ✅ 确认按钮: "Exit"
- ✅ 取消按钮: "Cancel"

---

## 性能测试

### 场景 13: 对话框响应时间

**测试目的**: 验证对话框显示的响应时间

**测试步骤**:
1. 开始导航
2. 按返回键
3. 使用秒表或录屏测量从按键到对话框显示的时间

**预期结果**:
- ✅ 响应时间 < 200ms
- ✅ 对话框显示流畅，无卡顿

**验证方法**:
- 使用 Android Studio Profiler 测量
- 或使用录屏工具逐帧分析

---

### 场景 14: 退出处理时间

**测试目的**: 验证从确认退出到 Activity 关闭的时间

**测试步骤**:
1. 开始导航
2. 按返回键显示对话框
3. 点击"退出"按钮
4. 测量从点击到 Activity 关闭的时间

**预期结果**:
- ✅ 处理时间 < 500ms
- ✅ 退出流畅，无延迟

---

## 兼容性测试

### 场景 15: Android 5.0 (API 21) 测试

**测试设备**: Android 5.0 设备或模拟器

**测试步骤**:
1. 在 Android 5.0 设备上安装应用
2. 执行场景 1-4 的所有测试

**预期结果**:
- ✅ 所有功能正常工作
- ✅ 使用 onBackPressed() 方法处理返回键
- ✅ 对话框显示正常

---

### 场景 16: Android 13+ (API 33+) 测试

**测试设备**: Android 13 或更高版本设备

**测试步骤**:
1. 在 Android 13+ 设备上安装应用
2. 执行场景 1-4 的所有测试
3. 测试预测性返回手势（从屏幕边缘滑动）

**预期结果**:
- ✅ 所有功能正常工作
- ✅ 使用 OnBackPressedCallback 处理返回键
- ✅ 支持预测性返回手势
- ✅ 对话框显示正常

---

## 日志验证

在测试过程中，使用 Android Studio Logcat 监控以下日志：

### 关键日志标签
```
Tag: NavigationActivity
```

### 预期日志输出

**场景 1 - 显示对话框**:
```
D/NavigationActivity: Back pressed, isNavigationInProgress=true
D/NavigationActivity: Exit confirmation dialog shown
```

**场景 2 - 点击取消**:
```
D/NavigationActivity: User cancelled exit navigation
D/NavigationActivity: Exit dialog dismissed
```

**场景 3 - 点击确认**:
```
D/NavigationActivity: User confirmed exit navigation
D/NavigationActivity: Stopping navigation
I/NavigationActivity: Sending event: navigation_cancelled
D/NavigationActivity: Activity finishing
```

**场景 4 - 未导航时退出**:
```
D/NavigationActivity: Back pressed, isNavigationInProgress=false
D/NavigationActivity: Navigation not in progress, finishing activity
```

**错误日志**:
```
E/NavigationActivity: Failed to show exit confirmation dialog
W/NavigationActivity: Activity is finishing or destroyed, cannot show dialog
W/NavigationActivity: Exit dialog is already showing, ignoring
```

---

## 测试检查清单

### 基本功能测试
- [ ] 场景 1: 导航中按返回键显示对话框
- [ ] 场景 2: 点击取消按钮继续导航
- [ ] 场景 3: 点击确认按钮退出导航
- [ ] 场景 4: 未开始导航时按返回键直接退出

### 主题测试
- [ ] 场景 5: 对话框在日间模式下显示正确
- [ ] 场景 6: 对话框在夜间模式下显示正确
- [ ] 场景 7: 对话框主题动态切换正常

### 边界场景测试（可选）
- [ ] 场景 8: 快速连续按返回键
- [ ] 场景 9: 对话框显示时旋转屏幕
- [ ] 场景 10: 对话框显示时应用进入后台

### 国际化测试
- [ ] 场景 11: 中文环境测试
- [ ] 场景 12: 英文环境测试

### 性能测试
- [ ] 场景 13: 对话框响应时间 < 200ms
- [ ] 场景 14: 退出处理时间 < 500ms

### 兼容性测试
- [ ] 场景 15: Android 5.0 (API 21) 测试
- [ ] 场景 16: Android 13+ (API 33+) 测试

---

## 测试报告模板

### 测试信息
- **测试人员**: ___________
- **测试日期**: ___________
- **测试设备**: ___________
- **Android 版本**: ___________
- **应用版本**: ___________

### 测试结果汇总
| 场景编号 | 场景名称 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 1 | 导航中按返回键显示对话框 | ☐ 通过 ☐ 失败 | |
| 2 | 点击取消按钮继续导航 | ☐ 通过 ☐ 失败 | |
| 3 | 点击确认按钮退出导航 | ☐ 通过 ☐ 失败 | |
| 4 | 未开始导航时按返回键直接退出 | ☐ 通过 ☐ 失败 | |
| 5 | 对话框日间模式显示 | ☐ 通过 ☐ 失败 | |
| 6 | 对话框夜间模式显示 | ☐ 通过 ☐ 失败 | |
| 7 | 对话框主题动态切换 | ☐ 通过 ☐ 失败 | |

### 发现的问题
1. **问题描述**: ___________
   - **严重程度**: ☐ 严重 ☐ 中等 ☐ 轻微
   - **复现步骤**: ___________
   - **预期结果**: ___________
   - **实际结果**: ___________
   - **截图/日志**: ___________

2. **问题描述**: ___________
   - **严重程度**: ☐ 严重 ☐ 中等 ☐ 轻微
   - **复现步骤**: ___________
   - **预期结果**: ___________
   - **实际结果**: ___________
   - **截图/日志**: ___________

### 测试结论
- ☐ 所有测试通过，功能正常
- ☐ 部分测试失败，需要修复
- ☐ 测试未完成，需要继续

### 建议和改进
___________

---

## 附录

### A. 测试环境配置

#### 启用开发者选项
1. 设置 → 关于手机
2. 连续点击"版本号" 7 次
3. 返回设置 → 开发者选项

#### 启用 USB 调试
1. 开发者选项 → USB 调试 → 开启
2. 连接电脑，授权 USB 调试

#### 查看日志
```bash
# 连接设备
adb devices

# 查看实时日志
adb logcat -s NavigationActivity:*

# 清除日志
adb logcat -c

# 保存日志到文件
adb logcat -s NavigationActivity:* > test_log.txt
```

### B. 常见问题排查

#### 问题 1: 对话框未显示
**可能原因**:
- isNavigationInProgress 状态错误
- Activity 已销毁
- 返回键事件未正确拦截

**排查步骤**:
1. 检查日志中的 isNavigationInProgress 值
2. 检查 setupBackPressedHandler() 是否被调用
3. 检查 handleBackPress() 是否被触发

#### 问题 2: 对话框样式错误
**可能原因**:
- 主题配置错误
- 颜色资源缺失
- 样式文件未正确应用

**排查步骤**:
1. 检查 res/values/styles.xml 中的 AlertDialogTheme
2. 检查颜色资源是否存在
3. 检查对话框创建时是否指定了主题

#### 问题 3: 导航未停止
**可能原因**:
- stopNavigation() 未被调用
- stopNavigation() 执行失败
- 事件未正确发送

**排查步骤**:
1. 检查日志中是否有 "Stopping navigation"
2. 检查 stopNavigation() 方法实现
3. 检查事件发送逻辑

### C. 参考资料

- [Android OnBackPressedDispatcher 文档](https://developer.android.com/guide/navigation/custom-back)
- [Material Design - Dialogs](https://material.io/components/dialogs)
- [Android 主题和样式](https://developer.android.com/guide/topics/ui/look-and-feel/themes)
- 项目需求文档: `.kiro/specs/android-back-button-confirmation/requirements.md`
- 项目设计文档: `.kiro/specs/android-back-button-confirmation/design.md`

---

## 文档版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|-----|------|---------|--------|
| 1.0 | 2024 | 初始版本 | - |

---

**测试指南结束**
