# 需求文档

## 简介

本功能旨在重构 NavigationReplayActivity，实现一个静态的历史轨迹渐变显示页面。用户可以查看完整的导航历史轨迹，轨迹颜色根据速度变化呈现渐变效果，无需播放动画。这将提供更直观的轨迹可视化体验，让用户快速了解整个行程的速度分布情况。

## 术语表

- **NavigationReplayActivity**: Android 端的导航历史回放页面
- **MapboxReplayer**: Mapbox Navigation SDK 提供的历史回放工具
- **ReplayLocationEngine**: 用于回放历史位置数据的引擎
- **LocationObserver**: 位置更新观察者，接收位置变化通知
- **GeoJsonSource**: Mapbox 地图的 GeoJSON 数据源，支持 lineMetrics
- **LineLayer**: Mapbox 地图的线图层，支持 lineGradient 渐变效果
- **lineGradient**: 线条渐变表达式，基于 line-progress 实现颜色渐变
- **line-progress**: 线条进度值（0-1），表示沿线的相对位置
- **lineMetrics**: GeoJsonSource 的属性，必须启用才能使用 lineGradient
- **Speed Gradient**: 速度渐变，根据速度值映射到不同颜色
- **Static Display**: 静态显示，一次性绘制完整轨迹，不播放动画

## 需求

### 需求 1

**用户故事:** 作为应用用户，我希望能够查看完整的历史轨迹，以便快速了解整个行程的路线。

#### 验收标准

1. WHEN 用户打开历史回放页面 THEN 系统应加载并显示完整的历史轨迹
2. WHEN 系统加载历史数据 THEN 系统应从历史文件中提取所有位置点
3. WHEN 系统绘制轨迹 THEN 轨迹应使用 GeoJSON LineString 表示
4. WHEN 轨迹绘制完成 THEN 地图相机应自动调整以显示完整轨迹
5. WHEN 轨迹包含起点和终点 THEN 系统应在地图上标记起点（绿色）和终点（红色）

### 需求 2

**用户故事:** 作为应用用户，我希望轨迹颜色能够反映速度变化，以便直观了解行程中的速度分布。

#### 验收标准

1. WHEN 系统绘制轨迹 THEN 轨迹颜色应根据速度呈现渐变效果
2. WHEN 速度低于 5 km/h THEN 轨迹应显示为蓝色（慢速/停车）
3. WHEN 速度在 5-10 km/h THEN 轨迹应显示为青色（休闲骑行）
4. WHEN 速度在 10-15 km/h THEN 轨迹应显示为绿色（正常骑行）
5. WHEN 速度在 15-20 km/h THEN 轨迹应显示为黄绿色（快速骑行）
6. WHEN 速度在 20-25 km/h THEN 轨迹应显示为黄色（高速骑行）
7. WHEN 速度在 25-30 km/h THEN 轨迹应显示为橙色（冲刺速度）
8. WHEN 速度超过 30 km/h THEN 轨迹应显示为红色（极速/下坡）

### 需求 3

**用户故事:** 作为应用用户，我希望页面加载快速且不播放动画，以便快速查看轨迹信息。

#### 验收标准

1. WHEN 用户打开页面 THEN 系统应立即开始加载历史数据
2. WHEN 历史数据加载完成 THEN 系统应一次性绘制完整轨迹，不播放动画
3. WHEN 轨迹绘制完成 THEN 系统应停止回放引擎，不继续播放位置更新
4. WHEN 页面加载时间超过 3 秒 THEN 系统应显示加载提示
5. WHEN 轨迹点数超过 1000 THEN 系统应优化绘制性能，确保流畅显示

### 需求 4

**用户故事:** 作为应用用户，我希望页面默认以全览模式显示完整轨迹，以便快速了解整个行程路线。

#### 验收标准

1. WHEN 页面加载完成 THEN 地图应自动调整到全览模式，显示完整轨迹
2. WHEN 计算全览视图 THEN 系统应计算轨迹边界并添加适当边距（30%）
3. WHEN 设置相机位置 THEN 系统应根据轨迹范围计算合适的缩放级别
4. WHEN 相机调整时 THEN 应使用平滑过渡动画，确保用户体验流畅
5. WHEN 轨迹范围很小 THEN 系统应使用较高的缩放级别以清晰显示细节

### 需求 5

**用户故事:** 作为应用用户，我希望页面 UI 清晰美观，以便获得良好的使用体验。

#### 验收标准

1. WHEN 页面加载 THEN 系统应显示透明状态栏和标题栏
2. WHEN 标题栏显示 THEN 标题栏应包含返回按钮和自定义标题
3. WHEN 用户点击返回按钮 THEN 系统应关闭当前页面
4. WHEN 地图组件显示 THEN 罗盘应位于标题栏下方，避免遮挡
5. WHEN 地图组件显示 THEN 比例尺应隐藏，保持界面简洁
6. WHEN 地图组件显示 THEN 全览按钮应隐藏，因为默认就是全览模式

### 需求 6

**用户故事:** 作为应用用户，我希望轨迹渐变效果准确反映速度变化，以便准确分析行程。

#### 验收标准

1. WHEN 系统计算渐变 THEN 系统应使用 lineGradient 和 line-progress 表达式
2. WHEN 系统构建渐变表达式 THEN 系统应根据累计距离计算每个点的进度值（0-1）
3. WHEN 渐变节点数量超过 20 THEN 系统应采样关键点，避免性能问题
4. WHEN 相邻渐变节点进度值相同 THEN 系统应跳过该节点，确保进度值严格递增
5. WHEN 轨迹绘制完成 THEN 渐变效果应平滑过渡，无明显色块

### 需求 7

**用户故事:** 作为应用开发者，我希望代码结构清晰，以便后续维护和扩展。

#### 验收标准

1. WHEN 实现轨迹绘制 THEN 系统应移除所有动画和回放相关代码
2. WHEN 实现轨迹绘制 THEN 系统应移除路线绘制组件（RouteLineAPI 等）
3. WHEN 实现轨迹绘制 THEN 系统应移除 LocationObserver 和位置跟踪逻辑
4. WHEN 实现轨迹绘制 THEN 系统应移除相机跟随和智能更新逻辑
5. WHEN 实现轨迹绘制 THEN 系统应移除全览/跟随模式切换相关代码
6. WHEN 实现渐变绘制 THEN 系统应将渐变逻辑封装为独立函数
7. WHEN 代码重构完成 THEN 所有临时禁用的功能（ReplayStats 等）应被移除或注释说明

### 需求 8

**用户故事:** 作为应用用户，我希望在加载失败时能够看到明确的错误提示，以便了解问题原因。

#### 验收标准

1. WHEN 历史文件路径为空 THEN 系统应记录警告日志并关闭页面
2. WHEN 历史文件不存在 THEN 系统应显示错误提示并关闭页面
3. WHEN 历史文件解析失败 THEN 系统应记录错误日志并显示错误提示
4. WHEN 轨迹点数少于 2 THEN 系统应记录警告日志并显示提示
5. WHEN 发生任何错误 THEN 系统应确保资源正确释放
